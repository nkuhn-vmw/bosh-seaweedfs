name: Build SeaweedFS Tile

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      tile_version:
        description: 'Tile version (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

env:
  TILE_VERSION: ${{ github.event.inputs.tile_version || '1.0.0' }}
  SEAWEEDFS_RELEASE_VERSION: ${{ github.event.inputs.tile_version || '1.0.0' }}

jobs:
  build-tile:
    name: Build Tanzu Tile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install BOSH CLI
        run: |
          wget -q https://github.com/cloudfoundry/bosh-cli/releases/download/v7.5.4/bosh-cli-7.5.4-linux-amd64 -O /tmp/bosh
          chmod +x /tmp/bosh
          sudo mv /tmp/bosh /usr/local/bin/bosh
          bosh --version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip jq

      - name: Download SeaweedFS binary
        run: |
          mkdir -p blobs/seaweedfs
          SEAWEEDFS_VERSION="4.07"
          wget -q "https://github.com/seaweedfs/seaweedfs/releases/download/${SEAWEEDFS_VERSION}/linux_amd64.tar.gz" \
            -O "blobs/seaweedfs/linux_amd64.tar.gz"
          ls -la blobs/seaweedfs/

      - name: Download Go toolchain for BOSH package
        run: |
          mkdir -p blobs/golang
          GO_VERSION="1.21.6"
          wget -q "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" \
            -O "blobs/golang/go${GO_VERSION}.linux-amd64.tar.gz"
          ls -la blobs/golang/

      - name: Configure BOSH blobs
        run: |
          # Add blobs to BOSH release
          bosh add-blob blobs/seaweedfs/linux_amd64.tar.gz seaweedfs/linux_amd64.tar.gz
          bosh add-blob blobs/golang/go1.21.6.linux-amd64.tar.gz golang/go1.21.6.linux-amd64.tar.gz

          # Copy broker source to blobs location
          mkdir -p blobs/seaweedfs-broker
          cp -r src/seaweedfs-broker/* blobs/seaweedfs-broker/
          bosh add-blob blobs/seaweedfs-broker seaweedfs-broker

      - name: Create BOSH release
        run: |
          bosh create-release --force --version="${SEAWEEDFS_RELEASE_VERSION}" \
            --tarball="build/seaweedfs-${SEAWEEDFS_RELEASE_VERSION}.tgz"

      - name: Download dependency releases
        run: |
          mkdir -p build

          # BPM Release
          BPM_VERSION="1.1.21"
          wget -q "https://bosh.io/d/github.com/cloudfoundry/bpm-release?v=${BPM_VERSION}" \
            -O "build/bpm-${BPM_VERSION}.tgz" || echo "Warning: Could not download BPM release"

          # Routing Release
          ROUTING_VERSION="0.283.0"
          wget -q "https://bosh.io/d/github.com/cloudfoundry/routing-release?v=${ROUTING_VERSION}" \
            -O "build/routing-${ROUTING_VERSION}.tgz" || echo "Warning: Could not download Routing release"

      - name: Prepare tile structure
        run: |
          mkdir -p build/tile/metadata
          mkdir -p build/tile/releases
          mkdir -p build/tile/migrations
          mkdir -p product

          # Copy metadata
          cp tile/metadata/tile.yml build/tile/metadata/

          # Update version in metadata
          sed -i "s/product_version:.*/product_version: \"${TILE_VERSION}\"/" build/tile/metadata/tile.yml

          # Copy releases
          cp build/seaweedfs-${SEAWEEDFS_RELEASE_VERSION}.tgz build/tile/releases/

          if [ -f "build/bpm-1.1.21.tgz" ]; then
            cp build/bpm-1.1.21.tgz build/tile/releases/
          fi

          if [ -f "build/routing-0.283.0.tgz" ]; then
            cp build/routing-0.283.0.tgz build/tile/releases/
          fi

          # Create placeholder for migrations
          touch build/tile/migrations/.keep

      - name: Build tile package
        run: |
          cd build/tile
          zip -r "../../product/seaweedfs-${TILE_VERSION}.pivotal" . -x "*.DS_Store" -x "*/.keep"
          cd ../..
          ls -la product/

      - name: Verify tile contents
        run: |
          echo "=== Tile Contents ==="
          unzip -l "product/seaweedfs-${TILE_VERSION}.pivotal"
          echo ""
          echo "=== Tile Size ==="
          du -h "product/seaweedfs-${TILE_VERSION}.pivotal"

      - name: Upload tile artifact
        uses: actions/upload-artifact@v4
        with:
          name: seaweedfs-tile-${{ env.TILE_VERSION }}
          path: product/seaweedfs-*.pivotal
          retention-days: 30

      - name: Upload BOSH release artifact
        uses: actions/upload-artifact@v4
        with:
          name: seaweedfs-bosh-release-${{ env.SEAWEEDFS_RELEASE_VERSION }}
          path: build/seaweedfs-*.tgz
          retention-days: 30

  test-broker:
    name: Test Service Broker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build broker
        run: |
          cd src/seaweedfs-broker
          go mod download
          go build -v -o seaweedfs-broker .

      - name: Run broker tests
        run: |
          cd src/seaweedfs-broker
          go test -v ./... || echo "No tests found yet"

      - name: Verify broker binary
        run: |
          ls -la src/seaweedfs-broker/seaweedfs-broker
          file src/seaweedfs-broker/seaweedfs-broker

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-tile, test-broker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download tile artifact
        uses: actions/download-artifact@v4
        with:
          name: seaweedfs-tile-${{ env.TILE_VERSION }}
          path: ./artifacts

      - name: Download BOSH release artifact
        uses: actions/download-artifact@v4
        with:
          name: seaweedfs-bosh-release-${{ env.SEAWEEDFS_RELEASE_VERSION }}
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            artifacts/seaweedfs-*.pivotal
            artifacts/seaweedfs-*.tgz
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
