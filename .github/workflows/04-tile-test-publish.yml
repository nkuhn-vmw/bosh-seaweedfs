name: Tile Test & Publish
on:
  repository_dispatch:
    types: [tile-built]
  workflow_dispatch:

jobs:
  test-and-publish:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Download tile
        uses: actions/download-artifact@v4
        with:
          name: tile
          path: tile/

      - name: Validate tile structure
        run: |
          TILE_FILE=$(ls tile/*.pivotal 2>/dev/null | head -1)
          if [ -z "${TILE_FILE}" ]; then
            echo "No .pivotal file found"
            exit 1
          fi
          echo "Tile file: ${TILE_FILE}"
          echo "Size: $(ls -lh ${TILE_FILE} | awk '{print $5}')"

          # Validate it's a valid zip (pivotal files are zip archives)
          unzip -t "${TILE_FILE}" > /dev/null

      - name: Extract tile version
        id: tile-version
        run: |
          TILE_FILE=$(ls tile/*.pivotal | head -1)
          # Extract metadata from tile
          unzip -p "${TILE_FILE}" metadata/*.yml | head -5
          VERSION=$(unzip -p "${TILE_FILE}" metadata/*.yml | grep 'product_version:' | awk '{print $2}' | tr -d "'\"")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Tile version: ${VERSION}"

      - name: Create GitHub Release
        if: github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          files: tile/*.pivotal
          tag_name: v${{ steps.tile-version.outputs.version }}
          name: SeaweedFS Tile v${{ steps.tile-version.outputs.version }}
          body: |
            SeaweedFS BOSH Tile release v${{ steps.tile-version.outputs.version }}

            ## Installation
            1. Upload to Ops Manager: `om upload-product -p seaweedfs-*.pivotal`
            2. Stage the product: `om stage-product -p seaweedfs`
            3. Configure and apply changes
          draft: false
          prerelease: false
