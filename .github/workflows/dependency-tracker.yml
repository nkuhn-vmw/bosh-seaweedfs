name: Dependency Tracker
on:
  schedule:
    - cron: '0 8 * * 1'  # Weekly on Monday at 8 AM UTC
  workflow_dispatch:

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Check Go version
        id: go-version
        run: |
          CURRENT_GO=$(grep '^go ' src/seaweedfs-broker/go.mod | awk '{print $2}')
          LATEST_GO=$(curl -s 'https://go.dev/VERSION?m=text' | head -1 | sed 's/go//')
          echo "current=${CURRENT_GO}" >> $GITHUB_OUTPUT
          echo "latest=${LATEST_GO}" >> $GITHUB_OUTPUT
          if [ "${CURRENT_GO}" != "${LATEST_GO}" ]; then
            echo "Go: ${CURRENT_GO} -> ${LATEST_GO}"
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Check SeaweedFS version
        id: seaweedfs-version
        run: |
          CURRENT=$(yq '.upstream.current' config/versions.yml)
          LATEST=$(gh api repos/seaweedfs/seaweedfs/releases/latest --jq '.tag_name')
          echo "current=${CURRENT}" >> $GITHUB_OUTPUT
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          if [ "${CURRENT}" != "${LATEST}" ]; then
            echo "SeaweedFS: ${CURRENT} -> ${LATEST}"
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check OTel Collector version
        id: otel-version
        run: |
          LATEST=$(gh api repos/open-telemetry/opentelemetry-collector-releases/releases/latest --jq '.tag_name')
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "OTel Collector latest: ${LATEST}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check BPM release version
        id: bpm-version
        run: |
          CURRENT=$(grep 'bpm-' resources/bpm-release.tgz 2>/dev/null | head -1 || echo "unknown")
          LATEST=$(gh api repos/cloudfoundry/bpm-release/releases/latest --jq '.tag_name')
          echo "current=${CURRENT}" >> $GITHUB_OUTPUT
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "BPM release latest: ${LATEST}"
          if [ "${CURRENT}" != "${LATEST}" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check routing release version
        id: routing-version
        run: |
          LATEST=$(gh api repos/cloudfoundry/routing-release/releases/latest --jq '.tag_name')
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "Routing release latest: ${LATEST}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check stemcell version
        id: stemcell-version
        run: |
          CURRENT=$(grep 'version' tile.yml | grep -A1 stemcell_criteria | tail -1 | awk -F"'" '{print $2}')
          LATEST=$(curl -s 'https://bosh.io/api/v1/stemcells/bosh-google-kvm-ubuntu-jammy-go_agent' | jq -r '.[0].version' 2>/dev/null || echo "unknown")
          echo "current=${CURRENT}" >> $GITHUB_OUTPUT
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "Stemcell (ubuntu-jammy): current=${CURRENT}, latest=${LATEST}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Write issue body
        if: steps.seaweedfs-version.outputs.has_update == 'true' || steps.go-version.outputs.has_update == 'true' || steps.bpm-version.outputs.has_update == 'true'
        run: |
          cat > /tmp/issue-body.md << 'EOF'
          ## Dependency Updates Available

          | Component | Current | Latest |
          |-----------|---------|--------|
          | SeaweedFS | ${{ steps.seaweedfs-version.outputs.current }} | ${{ steps.seaweedfs-version.outputs.latest }} |
          | Go | ${{ steps.go-version.outputs.current }} | ${{ steps.go-version.outputs.latest }} |
          | OTel Collector | — | ${{ steps.otel-version.outputs.latest }} |
          | BPM Release | ${{ steps.bpm-version.outputs.current }} | ${{ steps.bpm-version.outputs.latest }} |
          | Routing Release | — | ${{ steps.routing-version.outputs.latest }} |
          | Stemcell (ubuntu-jammy) | ${{ steps.stemcell-version.outputs.current }} | ${{ steps.stemcell-version.outputs.latest }} |
          EOF

      - name: Create summary issue
        if: steps.seaweedfs-version.outputs.has_update == 'true' || steps.go-version.outputs.has_update == 'true' || steps.bpm-version.outputs.has_update == 'true'
        uses: peter-evans/create-issue-from-file@e8ef132d6df98ed982188e460ebb3b5d4ef3a9cd # v5
        with:
          title: "Dependency updates available"
          content-filepath: /tmp/issue-body.md
          labels: ci-cd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
