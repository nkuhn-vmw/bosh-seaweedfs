name: BOSH Release Build
on:
  repository_dispatch:
    types: [new-upstream-version]
  workflow_dispatch:
    inputs:
      version:
        description: 'SeaweedFS version to build'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(yq '.upstream.current' config/versions.yml)" >> $GITHUB_OUTPUT
          fi

      - name: Download staged artifacts
        uses: actions/download-artifact@v4
        with:
          name: staged-upstream-${{ steps.version.outputs.version }}
          path: staged-artifacts/
        continue-on-error: true

      - name: Verify checksums
        if: hashFiles('staged-artifacts/checksums.sha256') != ''
        run: |
          cd staged-artifacts
          sha256sum -c checksums.sha256

      - name: Install BOSH CLI
        run: |
          curl -Lo bosh https://github.com/cloudfoundry/bosh-cli/releases/latest/download/bosh-cli-linux-amd64
          chmod +x bosh
          sudo mv bosh /usr/local/bin/bosh

      - name: Inject blob
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if [ -f "staged-artifacts/blobs/seaweedfs-${VERSION}-linux-amd64.tar.gz" ]; then
            bosh add-blob "staged-artifacts/blobs/seaweedfs-${VERSION}-linux-amd64.tar.gz" \
              "seaweedfs/seaweedfs-${VERSION}-linux-amd64.tar.gz"
          fi

      - name: Build Go broker
        run: |
          cd src/seaweedfs-broker
          go build ./...
          go vet ./...

      - name: Create dev release
        run: bosh create-release --force --tarball=seaweedfs-dev.tgz

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: bosh-release
          path: seaweedfs-dev.tgz
          retention-days: 7

      - name: Dispatch to Stage 3
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: bosh-release-promoted
          client-payload: '{"version": "${{ steps.version.outputs.version }}"}'
