name: Build and Release
on:
  repository_dispatch:
    types: [new-upstream-version]
  workflow_dispatch:
    inputs:
      tile_version:
        description: 'Tile version (e.g. 1.0.126). Auto-increments if empty.'
        required: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-bosh-release:
    runs-on: ubuntu-latest
    outputs:
      tile_version: ${{ steps.version.outputs.tile_version }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Determine tile version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tile_version }}" ]; then
            echo "tile_version=${{ github.event.inputs.tile_version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.version }}" ]; then
            # Auto-increment for upstream dispatches
            TILE_VERSION=$("scripts/get-next-version.sh")
            echo "tile_version=${TILE_VERSION}" >> $GITHUB_OUTPUT
          else
            TILE_VERSION=$("scripts/get-next-version.sh")
            echo "tile_version=${TILE_VERSION}" >> $GITHUB_OUTPUT
          fi
          echo "Building tile version: $(cat $GITHUB_OUTPUT | grep tile_version | cut -d= -f2)"

      - name: Install BOSH CLI
        run: |
          BOSH_CLI_VERSION=$(gh api repos/cloudfoundry/bosh-cli/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "Installing BOSH CLI ${BOSH_CLI_VERSION}"
          curl -sLo bosh "https://github.com/cloudfoundry/bosh-cli/releases/download/v${BOSH_CLI_VERSION}/bosh-cli-${BOSH_CLI_VERSION}-linux-amd64"
          chmod +x bosh
          sudo mv bosh /usr/local/bin/bosh
          bosh --version
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Cache blobs
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: blobs/
          key: bosh-blobs-${{ hashFiles('config/blobs.yml') }}
          restore-keys: bosh-blobs-

      - name: Build BOSH release
        run: |
          RELEASE_TARBALL=$(bash scripts/build-release.sh "${{ steps.version.outputs.tile_version }}")
          echo "release_tarball=${RELEASE_TARBALL}" >> $GITHUB_ENV
          echo "Built release: ${RELEASE_TARBALL}"

      - name: Upload BOSH release artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: bosh-release
          path: ${{ env.release_tarball }}
          retention-days: 7

      - name: Attest BOSH release provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-path: ${{ env.release_tarball }}

  build-tile:
    runs-on: ubuntu-latest
    needs: build-bosh-release
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download BOSH release
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: bosh-release
          path: release-artifact/

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install tile-generator
        run: pip install tile-generator

      - name: Build tile
        run: |
          RELEASE_FILE=$(ls release-artifact/*.tgz | head -1)
          echo "Using release: ${RELEASE_FILE}"
          bash scripts/build-tile.sh "${{ needs.build-bosh-release.outputs.tile_version }}" --release "${RELEASE_FILE}"

      - name: Upload tile artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: tile
          path: product/*.pivotal
          retention-days: 14

      - name: Attest tile provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-path: product/*.pivotal

  deploy-test:
    runs-on: ubuntu-latest
    needs: build-bosh-release
    if: vars.BOSH_ENVIRONMENT != ''
    environment: staging
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download BOSH release
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: bosh-release
          path: release-artifact/

      - name: Install BOSH CLI
        run: |
          BOSH_CLI_VERSION=$(gh api repos/cloudfoundry/bosh-cli/releases/latest --jq '.tag_name' | sed 's/^v//')
          curl -sLo bosh "https://github.com/cloudfoundry/bosh-cli/releases/download/v${BOSH_CLI_VERSION}/bosh-cli-${BOSH_CLI_VERSION}-linux-amd64"
          chmod +x bosh
          sudo mv bosh /usr/local/bin/bosh
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Deploy to BOSH-lite
        env:
          BOSH_ENVIRONMENT: ${{ vars.BOSH_ENVIRONMENT }}
          BOSH_CLIENT: ${{ secrets.BOSH_CLIENT }}
          BOSH_CLIENT_SECRET: ${{ secrets.BOSH_CLIENT_SECRET }}
          BOSH_CA_CERT: ${{ secrets.BOSH_CA_CERT }}
        run: |
          RELEASE_FILE=$(ls release-artifact/*.tgz | head -1)
          DEPLOYMENT_NAME="seaweedfs-ci-test"

          echo "Uploading release..."
          bosh upload-release "${RELEASE_FILE}"

          echo "Deploying ${DEPLOYMENT_NAME}..."
          bosh -n -d "${DEPLOYMENT_NAME}" deploy manifests/seaweedfs.yml \
            -v seaweedfs_master_address=10.244.0.2 \
            -v seaweedfs_filer_address=10.244.0.4

          echo "Waiting for deployment to settle..."
          sleep 30

          echo "Checking S3 connectivity..."
          S3_IP=$(bosh -d "${DEPLOYMENT_NAME}" vms --json | jq -r '.Tables[0].Rows[] | select(.instance | startswith("seaweedfs-s3")) | .ips')
          echo "S3 endpoint: ${S3_IP}:8333"

          # Basic health check
          curl -sf "http://${S3_IP}:8333/" -o /dev/null && echo "S3 gateway responding" || echo "S3 gateway check failed"

      - name: Cleanup deployment
        if: always()
        env:
          BOSH_ENVIRONMENT: ${{ vars.BOSH_ENVIRONMENT }}
          BOSH_CLIENT: ${{ secrets.BOSH_CLIENT }}
          BOSH_CLIENT_SECRET: ${{ secrets.BOSH_CLIENT_SECRET }}
          BOSH_CA_CERT: ${{ secrets.BOSH_CA_CERT }}
        run: |
          bosh -n -d "seaweedfs-ci-test" delete-deployment --force 2>/dev/null || true

  opsmanager-test:
    runs-on: ubuntu-latest
    needs: build-tile
    if: vars.OM_TARGET != ''
    environment: production
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download tile
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: tile
          path: tile/

      - name: Install OM CLI
        run: |
          OM_VERSION=$(gh api repos/pivotal-cf/om/releases/latest --jq '.tag_name' | sed 's/^v//')
          curl -sLo om "https://github.com/pivotal-cf/om/releases/download/${OM_VERSION}/om-linux-amd64-${OM_VERSION}"
          chmod +x om
          sudo mv om /usr/local/bin/om
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload and stage tile
        env:
          OM_TARGET: ${{ vars.OM_TARGET }}
          OM_USERNAME: ${{ secrets.OM_USERNAME }}
          OM_PASSWORD: ${{ secrets.OM_PASSWORD }}
          OM_SKIP_SSL_VALIDATION: "true"
        run: |
          TILE_FILE=$(ls tile/*.pivotal | head -1)
          echo "Uploading tile: ${TILE_FILE}"
          om upload-product -p "${TILE_FILE}"
          om stage-product -p seaweedfs

      - name: Configure product
        env:
          OM_TARGET: ${{ vars.OM_TARGET }}
          OM_USERNAME: ${{ secrets.OM_USERNAME }}
          OM_PASSWORD: ${{ secrets.OM_PASSWORD }}
          OM_SKIP_SSL_VALIDATION: "true"
        run: |
          om configure-product -c ci/opsmanager-config.yml

      - name: Apply changes
        env:
          OM_TARGET: ${{ vars.OM_TARGET }}
          OM_USERNAME: ${{ secrets.OM_USERNAME }}
          OM_PASSWORD: ${{ secrets.OM_PASSWORD }}
          OM_SKIP_SSL_VALIDATION: "true"
        run: |
          om apply-changes --product-name seaweedfs

  validate-and-release:
    runs-on: ubuntu-latest
    needs: [build-bosh-release, build-tile]
    environment: production
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download tile
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: tile
          path: tile/

      - name: Validate tile structure
        run: |
          TILE_FILE=$(ls tile/*.pivotal 2>/dev/null | head -1)
          if [ -z "${TILE_FILE}" ]; then
            echo "ERROR: No .pivotal file found"
            exit 1
          fi
          echo "Tile file: ${TILE_FILE}"
          echo "Size: $(ls -lh ${TILE_FILE} | awk '{print $5}')"

          # Validate it's a valid zip
          unzip -t "${TILE_FILE}" > /dev/null
          echo "Tile is a valid zip archive"

          # Show contents
          echo ""
          echo "Tile contents:"
          unzip -l "${TILE_FILE}" | head -20

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: tile/*.pivotal
          tag_name: v${{ needs.build-bosh-release.outputs.tile_version }}
          name: SeaweedFS Tile v${{ needs.build-bosh-release.outputs.tile_version }}
          body: |
            SeaweedFS BOSH Tile release v${{ needs.build-bosh-release.outputs.tile_version }}

            ## Installation
            1. Upload to Ops Manager: `om upload-product -p seaweedfs-*.pivotal`
            2. Stage the product: `om stage-product -p seaweedfs`
            3. Configure and apply changes
          draft: false
          prerelease: false
