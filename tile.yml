---
name: seaweedfs
icon_file: resources/icon.png
label: SeaweedFS Object Storage
version: 1.0.49
description: |
  SeaweedFS is a distributed storage system for blobs, objects, files, and data lake.
  This tile provides S3-compatible object storage with both shared and dedicated cluster options.

# Enable service broker - required for $self accessors (UAA client for BOSH access)
service_broker: true

# Require TAS/Elastic Runtime for gorouter integration, NATS, and CF APIs
requires_product_versions:
  - name: cf
    version: "~> 4.0"

stemcell_criteria:
  os: ubuntu-jammy
  version: '1.0'

# Service plan forms for operator-configurable on-demand plans
service_plan_forms:
  - name: on_demand_service_plans
    label: On-Demand Service Plans
    description: |
      Configure on-demand SeaweedFS cluster plans that provision dedicated instances.
      Each plan creates isolated SeaweedFS clusters for applications.
    optional: true
    properties:
      - name: plan_description
        type: string
        label: Plan Description
        description: Description shown to developers in the marketplace
        configurable: true
      - name: deployment_type
        type: dropdown_select
        label: Deployment Type
        description: |
          Single Node: Lightweight deployment with 1 master, 1 volume server, and 1 filer.
          Ideal for development, testing, and non-critical workloads. No data replication.

          High Availability: Production-ready deployment with 3 masters, 6 volume servers,
          and 3 filers across availability zones. Includes rack-aware replication for
          fault tolerance and automatic failover.
        default: single_node
        configurable: true
        options:
          - name: single_node
            label: "Single Node - Dev/Test (1 master, 1 volume, 1 filer)"
          - name: ha
            label: "High Availability - Production (3 masters, 6 volumes, 3 filers)"
      - name: vm_type
        type: vm_type_dropdown
        label: VM Type
        description: VM type for cluster nodes. Larger VMs provide more CPU and memory for better performance.
        configurable: true
      - name: disk_type
        type: disk_type_dropdown
        label: Persistent Disk Type
        description: Persistent disk type for data storage. Choose based on capacity and performance requirements.
        configurable: true
      - name: storage_quota_gb
        type: integer
        label: Storage Quota (GB)
        description: Maximum storage quota per service instance (enforced at bucket level)
        default: 100
        configurable: true
        constraints:
          min: 10
          max: 10000

packages:
  - name: seaweedfs
    type: bosh-release
    path: resources/seaweedfs-release.tgz
    jobs:
      # Shared cluster components
      - name: seaweedfs-master
        templates:
          - name: seaweedfs-master
            release: seaweedfs
          - name: route_registrar
            release: routing
            consumes:
              nats-tls:
                from: nats-tls
                deployment: (( ..cf.deployment_name ))
          - name: bpm
            release: bpm
        memory: 1024
        ephemeral_disk: 4096
        persistent_disk: 10240
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          route_registrar:
            routes:
              - name: seaweedfs-master
                port: 9333
                registration_interval: 20s
                uris:
                  - (( .properties.master_console_route_name.value )).(( ..cf.cloud_controller.system_domain.value ))
          seaweedfs:
            master:
              port: 9333
              default_replication: (( .properties.shared_replication.value ))

      - name: seaweedfs-volume
        templates:
          - name: seaweedfs-volume
            release: seaweedfs
          - name: bpm
            release: bpm
        memory: 2048
        ephemeral_disk: 4096
        persistent_disk: 102400
        instances: 3
        cpu: 2
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          seaweedfs:
            volume:
              max_volumes: (( .properties.shared_max_volumes.value ))

      - name: seaweedfs-filer
        templates:
          - name: seaweedfs-filer
            release: seaweedfs
          - name: route_registrar
            release: routing
            consumes:
              nats-tls:
                from: nats-tls
                deployment: (( ..cf.deployment_name ))
          - name: bpm
            release: bpm
        memory: 2048
        ephemeral_disk: 4096
        persistent_disk: 10240
        instances: 1
        cpu: 2
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          route_registrar:
            routes:
              - name: seaweedfs-filer
                port: 8888
                registration_interval: 20s
                uris:
                  - (( .properties.filer_console_route_name.value )).(( ..cf.cloud_controller.system_domain.value ))
          seaweedfs:
            filer: {}

      # S3 Gateway for external access
      - name: seaweedfs-s3
        templates:
          - name: seaweedfs-s3
            release: seaweedfs
          - name: bpm
            release: bpm
        memory: 1024
        ephemeral_disk: 4096
        persistent_disk: 1024
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          seaweedfs:
            s3:
              port: 8333
              tls:
                enabled: (( .properties.s3_tls_enabled.value ))
                certificate: (( .properties.s3_tls_certificate.cert_pem ))
                private_key: (( .properties.s3_tls_certificate.private_key_pem ))
              config:
                enabled: true
                identities:
                  - name: admin
                    credentials:
                      - accessKey: (( .properties.generated_s3_credentials.identity ))
                        secretKey: (( .properties.generated_s3_credentials.password ))
                    actions:
                      - "Admin"
                      - "Read"
                      - "Write"

      # Service Broker
      - name: seaweedfs-broker
        templates:
          - name: seaweedfs-broker
            release: seaweedfs
          - name: route_registrar
            release: routing
            consumes:
              nats-tls:
                from: nats-tls
                deployment: (( ..cf.deployment_name ))
          - name: bpm
            release: bpm
        memory: 1024
        ephemeral_disk: 4096
        persistent_disk: 2048
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          route_registrar:
            routes:
              - name: seaweedfs-broker
                port: 8080
                registration_interval: 20s
                uris:
                  - (( .properties.broker_route_name.value )).(( ..cf.cloud_controller.system_domain.value ))
          seaweedfs:
            broker:
              port: 8080
              auth:
                username: (( .properties.generated_broker_credentials.identity ))
                password: (( .properties.generated_broker_credentials.password ))
              catalog:
                icon_base64: (( .properties.catalog_icon_base64.value ))
              shared_cluster:
                enabled: (( .properties.shared_cluster_enabled.value ))
                # S3 endpoint derived from BOSH link (leave empty)
                s3_endpoint: ""
                use_ssl: (( .properties.s3_tls_enabled.value ))
                access_key: (( .properties.generated_s3_credentials.identity ))
                secret_key: (( .properties.generated_s3_credentials.password ))
              # BOSH Director configuration for on-demand deployments
              bosh:
                url: https://(( $director.hostname )):25555
                root_ca_cert: (( $director.ca_public_key ))
                authentication:
                  uaa:
                    url: https://(( $director.hostname )):8443
                    client_id: (( $self.uaa_client_name ))
                    client_secret: (( $self.uaa_client_secret ))
              on_demand:
                service_name: seaweedfs
                plans: (( .properties.on_demand_service_plans.value ))
                stemcell_os: ubuntu-jammy
                stemcell_version: "1.719"
                network: (( $self.service_network ))
              cf:
                system_domain: (( ..cf.cloud_controller.system_domain.value ))
                apps_domain: (( ..cf.cloud_controller.apps_domain.value ))

      # Register broker errand (post-deploy)
      - name: register-broker
        templates:
          - name: register-broker
            release: seaweedfs
        lifecycle: errand
        post_deploy: true
        memory: 512
        ephemeral_disk: 2048
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        properties:
          cf:
            api_url: https://api.(( ..cf.cloud_controller.system_domain.value ))
            admin_username: (( ..cf.uaa.system_services_credentials.identity ))
            admin_password: (( ..cf.uaa.system_services_credentials.password ))
            skip_ssl_validation: true
          broker:
            name: seaweedfs
            # Use routed URL via gorouter for stable, externally-accessible broker endpoint
            url: https://(( .properties.broker_route_name.value )).(( ..cf.cloud_controller.system_domain.value ))
            username: (( .properties.generated_broker_credentials.identity ))
            password: (( .properties.generated_broker_credentials.password ))
            enable_service_access: true

      # Deregister broker errand (pre-delete)
      - name: deregister-broker
        templates:
          - name: deregister-broker
            release: seaweedfs
        lifecycle: errand
        pre_delete: true
        memory: 512
        ephemeral_disk: 2048
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        properties:
          cf:
            api_url: https://api.(( ..cf.cloud_controller.system_domain.value ))
            admin_username: (( ..cf.uaa.system_services_credentials.identity ))
            admin_password: (( ..cf.uaa.system_services_credentials.password ))
            skip_ssl_validation: true
          broker:
            name: seaweedfs

  - name: bpm
    type: bosh-release
    path: resources/bpm-release.tgz

  - name: routing
    type: bosh-release
    path: resources/routing-release.tgz

forms:
  - name: endpoint_config
    label: Service Endpoints
    description: |
      Configure the endpoint hostnames for SeaweedFS services.
      These hostnames will be used with the system domain for service access.
    properties:
      - name: s3_route_name
        type: string
        label: S3 Endpoint Hostname
        description: |
          Hostname prefix for the S3 API endpoint (combined with system domain).
          Example: 'seaweedfs-s3' creates seaweedfs-s3.sys.example.com
        default: seaweedfs-s3
      - name: broker_route_name
        type: string
        label: Broker Endpoint Hostname
        description: |
          Hostname prefix for the service broker endpoint (combined with system domain).
          Used by Cloud Foundry to register and communicate with the service broker.
        default: seaweedfs-broker
      - name: master_console_enabled
        type: boolean
        label: Enable Master Console Route
        description: |
          Enable external access to the Master web console via gorouter.
        default: false
      - name: master_console_route_name
        type: string
        label: Master Console Hostname
        description: |
          Hostname prefix for the Master web console (combined with system domain).
          Example: 'seaweedfs-master' creates seaweedfs-master.sys.example.com
        default: seaweedfs-master
      - name: filer_console_enabled
        type: boolean
        label: Enable Filer Console Route
        description: |
          Enable external access to the Filer web console via gorouter.
        default: false
      - name: filer_console_route_name
        type: string
        label: Filer Console Hostname
        description: |
          Hostname prefix for the Filer web console (combined with system domain).
          Example: 'seaweedfs-filer' creates seaweedfs-filer.sys.example.com
        default: seaweedfs-filer

  - name: shared_cluster_config
    label: Shared Cluster Configuration
    description: |
      Configure the shared SeaweedFS cluster that provides the 'shared' service plan.
      The shared plan allows multiple applications to share a single SeaweedFS cluster,
      with each application receiving an isolated S3 bucket.
    properties:
      - name: shared_cluster_enabled
        type: boolean
        label: Enable Shared Cluster Plan
        description: |
          Enable the shared cluster plan which provides S3 buckets on a multi-tenant
          SeaweedFS cluster. Disable to only offer on-demand dedicated plans.
        default: true
      - name: shared_replication
        type: dropdown_select
        label: Replication Strategy
        description: Data replication strategy for fault tolerance
        default: "001"
        options:
          - name: "000"
            label: "No Replication (Development only)"
          - name: "001"
            label: "Same Rack - 1 replica (Standard)"
          - name: "010"
            label: "Different Rack - 1 replica (High Availability)"
          - name: "100"
            label: "Different Data Center - 1 replica (Disaster Recovery)"
      - name: shared_max_volumes
        type: integer
        label: Max Volumes per Server
        description: Maximum number of volumes each volume server can hold (affects total storage capacity)
        default: 100
        constraints:
          min: 10
          max: 1000
      - name: generated_broker_credentials
        type: simple_credentials
        label: Service Broker Credentials (Auto-generated)
        configurable: false
      - name: generated_s3_credentials
        type: simple_credentials
        label: S3 Admin Credentials (Auto-generated)
        configurable: false

  - name: service_catalog_config
    label: Service Catalog
    description: |
      Configure how SeaweedFS appears in the Cloud Foundry marketplace.
    properties:
      - name: catalog_icon_base64
        type: text
        label: Service Icon (Base64)
        description: |
          Base64-encoded PNG icon for the service catalog. This embeds the icon
          as a data URI, making it available in air-gapped environments without
          external network access. If left empty, the external SeaweedFS logo URL
          will be used as fallback. To generate, run: base64 -i icon.png | tr -d '\n'
        default: ""
        optional: true

  - name: tls_config
    label: TLS/SSL Configuration
    description: |
      Configure TLS/SSL encryption for the SeaweedFS S3 endpoint.
      When enabled, the S3 API will use HTTPS for secure communication.
    properties:
      - name: s3_tls_enabled
        type: boolean
        label: Enable TLS for S3 Endpoint
        description: |
          Enable TLS encryption for the S3 API endpoint. When enabled, clients
          must use HTTPS to connect to the S3 endpoint.
        default: false
      - name: s3_tls_certificate
        type: rsa_cert_credentials
        label: S3 TLS Certificate
        description: |
          TLS certificate for the S3 endpoint. Auto-generated by Ops Manager
          when TLS is enabled.

