#!/bin/bash

set -eu

export PATH="/var/vcap/packages/cf-cli/bin:$PATH"

export CF_HOME=$(mktemp -d)
trap "rm -rf $CF_HOME" EXIT

CF_API="<%= p('cf.api_url') %>"
CF_USER="<%= p('cf.admin_username') %>"
CF_PASSWORD="<%= p('cf.admin_password') %>"
SKIP_SSL="<%= p('cf.skip_ssl_validation') %>"

BROKER_NAME="<%= p('broker.name') %>"

echo "Logging into Cloud Foundry..."
if [ "$SKIP_SSL" = "true" ]; then
  cf api "$CF_API" --skip-ssl-validation
else
  cf api "$CF_API"
fi

cf auth "$CF_USER" "$CF_PASSWORD"

echo "Checking if broker '$BROKER_NAME' exists..."
if cf service-brokers | grep -q "^${BROKER_NAME}"; then
  echo "Disabling service access for seaweedfs service..."
  cf disable-service-access seaweedfs || true

  echo "Deleting broker '$BROKER_NAME'..."
  cf delete-service-broker "$BROKER_NAME" -f
  echo "Broker deregistration complete!"
else
  echo "Broker '$BROKER_NAME' not found, nothing to do."
fi
