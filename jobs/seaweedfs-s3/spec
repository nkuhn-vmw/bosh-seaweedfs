---
name: seaweedfs-s3
packages:
  - seaweedfs
templates:
  bpm.yml.erb: config/bpm.yml
  ctl.erb: bin/ctl
  pre-start.erb: bin/pre-start
  s3.json.erb: config/s3.json
  tls_cert.pem.erb: config/certs/tls_cert.pem
  tls_key.pem.erb: config/certs/tls_key.pem
  health_check.erb: bin/health_check
  ca.pem.erb: config/certs/ca.pem
  cert.pem.erb: config/certs/cert.pem
  key.pem.erb: config/certs/key.pem
  security.toml.erb: config/security.toml

provides:
  - name: seaweedfs-s3
    type: seaweedfs-s3
    properties:
      - seaweedfs.s3.port

consumes:
  - name: seaweedfs-filer
    type: seaweedfs-filer
    optional: true

properties:
  seaweedfs.s3.port:
    description: "Port for S3 gateway"
    default: 8333
  seaweedfs.s3.port_grpc:
    description: "gRPC port for S3 gateway"
    default: 18333
  seaweedfs.s3.filer:
    description: "Filer server address"
    default: "localhost:8888"
  seaweedfs.s3.ip_bind:
    description: "IP address to bind to"
    default: "0.0.0.0"
  seaweedfs.s3.metrics_port:
    description: "Metrics port for Prometheus"
    default: 9327
  seaweedfs.s3.domain_name:
    description: "Domain name for virtual hosted-style requests"
    default: ""
  seaweedfs.s3.allow_empty_folder:
    description: "Allow creating empty folder"
    default: false

  # TLS configuration
  seaweedfs.s3.tls.enabled:
    description: "Enable TLS for S3 endpoint"
    default: false
  seaweedfs.s3.tls.certificate:
    description: "TLS certificate for S3 endpoint"
    default: ""
  seaweedfs.s3.tls.private_key:
    description: "TLS private key for S3 endpoint"
    default: ""

  seaweedfs.s3.config.enabled:
    description: "Enable S3 config file with credentials"
    default: false
  seaweedfs.s3.iam.enabled:
    description: "Enable IAM API for dynamic credential management"
    default: true

  tls.ca:
    description: "CA certificate for mTLS"
    default: ""
  tls.certificate:
    description: "Server certificate"
    default: ""
  tls.private_key:
    description: "Server private key"
    default: ""

  # NATS CA cert for co-located route_registrar (on-demand deployments)
  nats.tls.ca_cert:
    description: "NATS server CA certificate. When set and route_registrar is co-located, this is written to the route_registrar config directory for TLS verification."
    default: ""

  seaweedfs.s3.config.identities:
    description: "List of S3 identities with credentials"
    default: []
    example:
      - name: admin
        credentials:
          - accessKey: "AKIAIOSFODNN7EXAMPLE"
            secretKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
        actions:
          - "Admin"
          - "Read"
          - "Write"
      - name: readonly
        credentials:
          - accessKey: "AKIAIOSFODNN7READONLY"
            secretKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYREADONLY"
        actions:
          - "Read"
