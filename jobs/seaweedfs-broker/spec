---
name: seaweedfs-broker

templates:
  ctl.erb: bin/ctl
  broker.yml.erb: config/broker.yml
  bpm.yml.erb: config/bpm.yml
  ca.crt.erb: config/certs/ca.crt
  server.crt.erb: config/certs/server.crt
  server.key.erb: config/certs/server.key
  bosh_ca.crt.erb: config/certs/bosh_ca.crt
  health_check.erb: bin/health_check

packages:
  - seaweedfs-broker

consumes:
  - name: seaweedfs-s3
    type: seaweedfs-s3
    optional: true
  - name: nats-tls
    type: nats-tls
    optional: true

provides:
  - name: seaweedfs-broker
    type: seaweedfs-broker
    properties:
      - seaweedfs.broker.port

properties:
  seaweedfs.broker.port:
    description: "Port for the service broker API"
    default: 8080

  seaweedfs.broker.log_level:
    description: "Log level (debug, info, warn, error)"
    default: "info"

  seaweedfs.broker.auth.username:
    description: "Basic auth username for the broker API"
    default: "broker"

  seaweedfs.broker.auth.password:
    description: "Basic auth password for the broker API"

  seaweedfs.broker.tls.enabled:
    description: "Enable TLS for the broker API"
    default: false

  seaweedfs.broker.tls.ca:
    description: "CA certificate for TLS"
    default: ""

  seaweedfs.broker.tls.certificate:
    description: "Server certificate for TLS"
    default: ""

  seaweedfs.broker.tls.private_key:
    description: "Server private key for TLS"
    default: ""

  # Catalog configuration
  seaweedfs.broker.catalog.service_id:
    description: "Service ID for the broker catalog"
    default: "seaweedfs-service"

  seaweedfs.broker.catalog.service_name:
    description: "Service name for the broker catalog"
    default: "seaweedfs"

  seaweedfs.broker.catalog.service_description:
    description: "Service description for the broker catalog"
    default: "SeaweedFS distributed object storage with S3-compatible API"

  seaweedfs.broker.catalog.icon_url:
    description: |
      URL for the service catalog icon displayed in the CF marketplace.
      The broker serves an embedded icon at /icon.png, so this should typically be
      https://<broker-route>.<system_domain>/icon.png
    default: ""

  # Shared cluster configuration
  seaweedfs.broker.shared_cluster.enabled:
    description: "Whether the shared cluster plan is enabled"
    default: true

  seaweedfs.broker.shared_cluster.plan_name:
    description: "Name of the shared plan in the marketplace"
    default: "shared"

  seaweedfs.broker.shared_cluster.plan_description:
    description: "Description of the shared plan in the marketplace"
    default: "Shared SeaweedFS cluster with dedicated bucket"

  seaweedfs.broker.shared_cluster.s3_endpoint:
    description: "S3 endpoint of the shared SeaweedFS cluster"
    default: ""

  seaweedfs.broker.shared_cluster.filer_endpoint:
    description: "Filer endpoint of the shared SeaweedFS cluster"
    default: ""

  seaweedfs.broker.shared_cluster.access_key:
    description: "Admin access key for the shared cluster"
    default: ""

  seaweedfs.broker.shared_cluster.secret_key:
    description: "Admin secret key for the shared cluster"
    default: ""

  seaweedfs.broker.shared_cluster.use_ssl:
    description: "Use SSL/TLS for S3 connections (via gorouter)"
    default: true

  seaweedfs.broker.shared_cluster.use_dns:
    description: "Use BOSH DNS names instead of IP addresses for service bindings"
    default: true

  seaweedfs.broker.shared_cluster.region:
    description: "S3 region for the shared cluster"
    default: "us-east-1"

  # BOSH configuration for on-demand instances (ODB-style structure)
  seaweedfs.broker.bosh.url:
    description: "BOSH Director URL (e.g., https://director:25555)"
    default: ""

  seaweedfs.broker.bosh.root_ca_cert:
    description: "BOSH Director root CA certificate"
    default: ""

  seaweedfs.broker.bosh.authentication.uaa.url:
    description: "UAA URL for BOSH authentication (e.g., https://director:8443)"
    default: ""

  seaweedfs.broker.bosh.authentication.uaa.client_id:
    description: "UAA client ID for BOSH access"
    default: ""

  seaweedfs.broker.bosh.authentication.uaa.client_secret:
    description: "UAA client secret for BOSH access"
    default: ""

  # On-demand deployment configuration
  seaweedfs.broker.on_demand.service_name:
    description: "Service name for on-demand deployments"
    default: "seaweedfs"

  seaweedfs.broker.on_demand.plans:
    description: |
      Array of on-demand plans configured via Ops Manager service_plan_forms.
      Each plan contains: name, guid, plan_description, deployment_type, vm_type, disk_type, storage_quota_gb
    default: []

  seaweedfs.broker.on_demand.stemcell_os:
    description: "Stemcell OS for on-demand deployments"
    default: "ubuntu-jammy"

  seaweedfs.broker.on_demand.stemcell_version:
    description: "Stemcell version for on-demand deployments"
    default: "latest"

  seaweedfs.broker.on_demand.network:
    description: "Network for on-demand deployments"
    default: "default"

  seaweedfs.broker.on_demand.azs:
    description: "Availability zones for on-demand deployments (array). Uses the AZs assigned to the tile in Ops Manager."
    default: ["z1", "z2", "z3"]

  # Cloud Foundry integration configuration
  seaweedfs.broker.cf.system_domain:
    description: "Cloud Foundry system domain for constructing console URLs"
    default: ""

  seaweedfs.broker.cf.apps_domain:
    description: "Cloud Foundry apps domain for on-demand console routes"
    default: ""

  seaweedfs.broker.cf.deployment_name:
    description: "CF BOSH deployment name for cross-deployment link consumption (e.g., cf-abc123)"
    default: ""

  # Legacy properties for backwards compatibility
  seaweedfs.broker.bosh.deployment_prefix:
    description: "Prefix for on-demand deployment names"
    default: "seaweedfs-ondemand"

  seaweedfs.broker.bosh.release_name:
    description: "SeaweedFS BOSH release name"
    default: "seaweedfs"

  seaweedfs.broker.bosh.release_version:
    description: "SeaweedFS BOSH release version"
    default: "latest"

  # Route registrar configuration (for Cloud Foundry integration)
  seaweedfs.broker.route_registrar.enabled:
    description: "Enable route registration with Cloud Foundry router"
    default: false

  seaweedfs.broker.route_registrar.routes:
    description: "Routes to register with the Cloud Foundry router"
    default: []

  # NATS TLS configuration for on-demand route registration
  seaweedfs.broker.nats.tls.enabled:
    description: "Enable NATS TLS for on-demand route registration"
    default: true

  seaweedfs.broker.nats.tls.client_cert:
    description: "NATS client certificate for on-demand route registration"
    default: ""

  seaweedfs.broker.nats.tls.client_key:
    description: "NATS client private key for on-demand route registration"
    default: ""

  seaweedfs.broker.nats.tls.ca_cert:
    description: "NATS CA certificate for on-demand route registration"
    default: ""

  # Routing release info for on-demand deployments
  seaweedfs.broker.on_demand.routing_release_version:
    description: "Version of the routing release to use for on-demand deployments"
    default: "latest"

  # Syslog forwarding configuration for on-demand deployments
  seaweedfs.broker.on_demand.syslog.address:
    description: "Syslog drain host:port for on-demand clusters (leave empty to disable)"
    default: ""
  seaweedfs.broker.on_demand.syslog.transport:
    description: "Transport protocol for syslog (tcp, udp, relp)"
    default: "tcp"
  seaweedfs.broker.on_demand.syslog.tls_enabled:
    description: "Enable TLS for syslog transport on on-demand clusters"
    default: false
  seaweedfs.broker.on_demand.syslog.ca_cert:
    description: "CA certificate for TLS syslog on on-demand clusters"
    default: ""
  seaweedfs.broker.on_demand.syslog.permitted_peer:
    description: "Permitted peer for TLS verification on on-demand clusters"
    default: ""

  # OpenTelemetry configuration for on-demand deployments
  seaweedfs.broker.on_demand.otel.otlp_endpoint:
    description: "OTLP exporter endpoint for on-demand clusters (leave empty to disable)"
    default: ""
  seaweedfs.broker.on_demand.otel.otlp_protocol:
    description: "OTLP protocol (grpc or http) for on-demand clusters"
    default: "grpc"
  seaweedfs.broker.on_demand.otel.otlp_ca_cert:
    description: "TLS CA certificate for OTLP endpoint on on-demand clusters"
    default: ""
  seaweedfs.broker.on_demand.otel.scrape_interval:
    description: "Metrics scrape interval for on-demand clusters (e.g. 30s, 1m)"
    default: "30s"
  seaweedfs.broker.on_demand.otel.enable_host_metrics:
    description: "Enable host-level CPU/memory/disk metrics on on-demand clusters"
    default: true

  # Backup configuration for on-demand deployments
  seaweedfs.broker.on_demand.backup.enabled:
    description: "Enable scheduled backups on on-demand clusters"
    default: false
  seaweedfs.broker.on_demand.backup.schedule:
    description: "Cron expression for backup schedule on on-demand clusters"
    default: "0 2 * * *"
  seaweedfs.broker.on_demand.backup.destination_type:
    description: "Backup destination for on-demand clusters: local, nfs, s3"
    default: "local"
  seaweedfs.broker.on_demand.backup.s3_endpoint:
    description: "S3-compatible endpoint for on-demand backup storage"
    default: ""
  seaweedfs.broker.on_demand.backup.s3_bucket:
    description: "S3 bucket for on-demand backup storage"
    default: ""
  seaweedfs.broker.on_demand.backup.s3_access_key:
    description: "S3 access key for on-demand backup destination"
    default: ""
  seaweedfs.broker.on_demand.backup.s3_secret_key:
    description: "S3 secret key for on-demand backup destination"
    default: ""
  seaweedfs.broker.on_demand.backup.retention_count:
    description: "Number of backups to retain on on-demand clusters"
    default: 7

  # CredHub integration for per-binding credential storage
  seaweedfs.broker.credhub.url:
    description: "CredHub API URL (e.g., https://credhub.service.cf.internal:8844)"
    default: ""
  seaweedfs.broker.credhub.client_id:
    description: "UAA client ID for CredHub authentication"
    default: ""
  seaweedfs.broker.credhub.client_secret:
    description: "UAA client secret for CredHub authentication"
    default: ""
  seaweedfs.broker.credhub.ca_cert:
    description: "CA certificate for CredHub TLS verification"
    default: ""
