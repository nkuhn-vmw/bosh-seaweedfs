<%
  require 'json'
  require 'securerandom'

  broker = p('seaweedfs.broker')

  # Handle shared cluster endpoint from link or property
  shared_s3_endpoint = p('seaweedfs.broker.shared_cluster.s3_endpoint')
  shared_cluster_enabled = p('seaweedfs.broker.shared_cluster.enabled')
  use_dns = p('seaweedfs.broker.shared_cluster.use_dns', true)
  if_link('seaweedfs-s3') do |s3_link|
    if shared_s3_endpoint.empty? && shared_cluster_enabled
      s3_instance = s3_link.instances.first
      # Use BOSH DNS name if available and use_dns is enabled, otherwise fall back to IP
      if use_dns && s3_instance.respond_to?(:dns) && !s3_instance.dns.nil?
        shared_s3_endpoint = "#{s3_instance.dns}:#{s3_link.p('seaweedfs.s3.port')}"
      else
        # Construct BOSH DNS name: q-s<index>.<job>.<network>.<deployment>.bosh
        # This follows the BOSH DNS naming convention for internal names
        shared_s3_endpoint = "#{s3_instance.address}:#{s3_link.p('seaweedfs.s3.port')}"
      end
    end
  end

  # Parse on-demand plans from tile service_plan_forms
  on_demand_plans_raw = p('seaweedfs.broker.on_demand.plans')
  on_demand_network = p('seaweedfs.broker.on_demand.network')
  on_demand_azs = p('seaweedfs.broker.on_demand.azs')

  # Handle azs - could be array or comma-separated string
  if on_demand_azs.is_a?(String)
    on_demand_azs = on_demand_azs.split(',').map(&:strip)
  end

  on_demand_plans = []
  if on_demand_plans_raw.is_a?(Array) && !on_demand_plans_raw.empty?
    on_demand_plans = on_demand_plans_raw.map do |plan|
      # Generate a stable plan ID from the plan GUID if provided
      plan_id = plan['guid'] || "ondemand-#{SecureRandom.uuid}"
      plan_name = plan['name'] || "ondemand-#{plan_id[0..7]}"

      # Map deployment_type to node counts
      deployment_type = plan['deployment_type'] || 'single_node'
      if deployment_type == 'ha'
        master_nodes = 3
        volume_nodes = 6
        filer_nodes = 3
        replication = '010'  # Different rack for HA
      else
        # single_node deployment
        master_nodes = 1
        volume_nodes = 1
        filer_nodes = 1
        replication = '000'  # No replication for single node
      end

      {
        'id' => plan_id,
        'name' => plan_name,
        'description' => plan['plan_description'] || "On-demand SeaweedFS cluster (#{deployment_type == 'ha' ? 'HA' : 'Single Node'})",
        'free' => false,
        'plan_type' => 'dedicated',
        'deployment_type' => deployment_type,
        'storage_quota_gb' => plan['storage_quota_gb'] || 100,
        'dedicated_config' => {
          'vm_type' => plan['vm_type'] || 'medium',
          'disk_type' => plan['disk_type'] || '50GB',
          'master_nodes' => master_nodes,
          'volume_nodes' => volume_nodes,
          'filer_nodes' => filer_nodes,
          'replication' => replication,
          'network' => on_demand_network,
          'azs' => on_demand_azs
        }
      }
    end
  end

  # Build static plans list - only include shared if enabled
  static_plans = []
  if shared_cluster_enabled
    static_plans << {
      'id' => 'shared-bucket',
      'name' => 'shared',
      'description' => 'Shared SeaweedFS cluster with dedicated bucket',
      'free' => true,
      'plan_type' => 'shared'
    }
  end

  # Merge static plans with on-demand plans
  all_plans = static_plans + on_demand_plans
%>
---
listen_addr: ":<%= p('seaweedfs.broker.port') %>"
log_level: "<%= p('seaweedfs.broker.log_level') %>"

auth:
  username: "<%= p('seaweedfs.broker.auth.username') %>"
  password: "<%= p('seaweedfs.broker.auth.password') %>"

tls:
  enabled: <%= p('seaweedfs.broker.tls.enabled') %>
<% if p('seaweedfs.broker.tls.enabled') %>
  cert_file: "/var/vcap/jobs/seaweedfs-broker/config/certs/server.crt"
  key_file: "/var/vcap/jobs/seaweedfs-broker/config/certs/server.key"
<% end %>

catalog:
  services:
    - id: "<%= p('seaweedfs.broker.catalog.service_id') %>"
      name: "<%= p('seaweedfs.broker.catalog.service_name') %>"
      description: "<%= p('seaweedfs.broker.catalog.service_description') %>"
      bindable: true
      tags:
        - seaweedfs
        - s3
        - object-storage
        - blob-storage
      metadata:
        displayName: "SeaweedFS"
<% icon_base64 = p('seaweedfs.broker.catalog.icon_base64', '') %>
<% if !icon_base64.empty? %>
        imageUrl: "data:image/png;base64,<%= icon_base64 %>"
<% else %>
        imageUrl: "https://seaweedfs.github.io/seaweedfs/images/SeaweedFS_Logo.png"
<% end %>
        longDescription: "SeaweedFS is a distributed storage system for blobs, objects, files, and data lake, with O(1) disk seek and cloud tiering."
        providerDisplayName: "SeaweedFS"
        documentationUrl: "https://github.com/seaweedfs/seaweedfs/wiki"
        supportUrl: "https://github.com/seaweedfs/seaweedfs/issues"
      plans:
<% all_plans.each do |plan| %>
        - id: "<%= plan['id'] %>"
          name: "<%= plan['name'] %>"
          description: "<%= plan['description'] %>"
          free: <%= plan['free'] %>
          plan_type: "<%= plan['plan_type'] %>"
          metadata:
            displayName: "<%= plan['name'].capitalize %>"
            bullets:
<% if plan['plan_type'] == 'shared' %>
              - "Shared SeaweedFS cluster"
              - "Dedicated S3 bucket"
              - "S3-compatible API"
<% else %>
              - "Dedicated SeaweedFS cluster"
              - "Isolated compute and storage"
              - "Configurable cluster size"
<% end %>
<% if plan['dedicated_config'] %>
          dedicated_config:
            vm_type: "<%= plan['dedicated_config']['vm_type'] %>"
            disk_type: "<%= plan['dedicated_config']['disk_type'] %>"
            master_nodes: <%= plan['dedicated_config']['master_nodes'] %>
            volume_nodes: <%= plan['dedicated_config']['volume_nodes'] %>
            filer_nodes: <%= plan['dedicated_config']['filer_nodes'] %>
            replication: "<%= plan['dedicated_config']['replication'] || '001' %>"
            network: "<%= plan['dedicated_config']['network'] %>"
            azs:
<% plan['dedicated_config']['azs'].each do |az| %>
              - "<%= az %>"
<% end %>
<% end %>
<% end %>

shared_cluster:
  enabled: <%= shared_cluster_enabled %>
  s3_endpoint: "<%= shared_s3_endpoint %>"
  filer_endpoint: "<%= p('seaweedfs.broker.shared_cluster.filer_endpoint') %>"
  access_key: "<%= p('seaweedfs.broker.shared_cluster.access_key') %>"
  secret_key: "<%= p('seaweedfs.broker.shared_cluster.secret_key') %>"
  use_ssl: <%= p('seaweedfs.broker.shared_cluster.use_ssl') %>
  region: "<%= p('seaweedfs.broker.shared_cluster.region') %>"

cf:
  system_domain: "<%= p('seaweedfs.broker.cf.system_domain', '') %>"
  apps_domain: "<%= p('seaweedfs.broker.cf.apps_domain', '') %>"

bosh:
  url: "<%= p('seaweedfs.broker.bosh.url') %>"
<% bosh_ca_cert = p('seaweedfs.broker.bosh.root_ca_cert') %>
<% if !bosh_ca_cert.to_s.empty? %>
  root_ca_cert: |
<%= bosh_ca_cert.gsub(/^/, '    ') %>
<% end %>
  authentication:
    uaa:
      url: "<%= p('seaweedfs.broker.bosh.authentication.uaa.url') %>"
      client_id: "<%= p('seaweedfs.broker.bosh.authentication.uaa.client_id') %>"
      client_secret: "<%= p('seaweedfs.broker.bosh.authentication.uaa.client_secret') %>"
  deployment_prefix: "<%= p('seaweedfs.broker.bosh.deployment_prefix') %>"
  release_name: "<%= p('seaweedfs.broker.bosh.release_name') %>"
  release_version: "<%= p('seaweedfs.broker.bosh.release_version') %>"
  stemcell_os: "<%= p('seaweedfs.broker.on_demand.stemcell_os') %>"
  stemcell_version: "<%= p('seaweedfs.broker.on_demand.stemcell_version') %>"

state_store:
  type: "file"
  path: "/var/vcap/store/seaweedfs-broker/state.json"
