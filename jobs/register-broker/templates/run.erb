#!/bin/bash

set -eu

export PATH="/var/vcap/packages/cf-cli/bin:$PATH"

export CF_HOME=$(mktemp -d)
trap "rm -rf $CF_HOME" EXIT

CF_API="<%= p('cf.api_url') %>"
CF_USER="<%= p('cf.admin_username') %>"
CF_PASSWORD="<%= p('cf.admin_password') %>"
SKIP_SSL="<%= p('cf.skip_ssl_validation') %>"

BROKER_NAME="<%= p('broker.name') %>"
<%
  # Get broker URL from link or property
  broker_url = p('broker.url', '')
  if broker_url.empty?
    broker_link = link('seaweedfs-broker')
    broker_instance = broker_link.instances.first
    broker_port = broker_link.p('seaweedfs.broker.port')
    broker_url = "http://#{broker_instance.address}:#{broker_port}"
  end
%>
BROKER_URL="<%= broker_url %>"
BROKER_USER="<%= p('broker.username') %>"
BROKER_PASSWORD="<%= p('broker.password') %>"
ENABLE_ACCESS="<%= p('broker.enable_service_access') %>"

echo "Logging into Cloud Foundry..."
if [ "$SKIP_SSL" = "true" ]; then
  cf api "$CF_API" --skip-ssl-validation
else
  cf api "$CF_API"
fi

cf auth "$CF_USER" "$CF_PASSWORD"

echo "Checking if broker '$BROKER_NAME' already exists..."
if cf service-brokers | grep -q "^${BROKER_NAME}"; then
  echo "Broker already exists, updating..."
  cf update-service-broker "$BROKER_NAME" "$BROKER_USER" "$BROKER_PASSWORD" "$BROKER_URL"
else
  echo "Creating new broker..."
  cf create-service-broker "$BROKER_NAME" "$BROKER_USER" "$BROKER_PASSWORD" "$BROKER_URL"
fi

if [ "$ENABLE_ACCESS" = "true" ]; then
  echo "Enabling service access for seaweedfs service..."
  cf enable-service-access seaweedfs || true
fi

echo "Broker registration complete!"
cf service-brokers
